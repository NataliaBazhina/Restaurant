{% extends "reservation/home.html" %}

{% block title %}{% if form.instance.pk %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è{% else %}–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="mb-4">{% if form.instance.pk %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è{% else %}–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞{% endif %}</h2>

        {% if messages %}
            {% for message in messages %}
                {% if message.tags != 'success' %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <form method="post" id="reservation-form">
            {% csrf_token %}

            <!-- –î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-header">–î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                <div class="card-body">
                    <!-- –ó–∞–ª -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª *</label>
                                {{ form.hall }}
                                {% if form.hall.errors %}
                                <div class="text-danger">{{ form.hall.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    <a href="#" id="view-hall-schema" style="display: none;" target="_blank">
                                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ö–µ–º—É –∑–∞–ª–∞
                                    </a>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞ *</label>
                                <input type="date" name="date" value="{{ form.date.value|date:'Y-m-d' }}"
                                       class="form-control" required
                                       pattern="\d{2}.\d{2}.\d{4}"
                                       placeholder="–¥–¥.–º–º.–≥–≥–≥–≥">
                                {% if form.date.errors %}
                                <div class="text-danger">{{ form.date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–í—Ä–µ–º—è *</label>
                                <input type="time" name="start_time" value="{{ form.start_time.value|time:'H:i' }}"
                                       class="form-control" required
                                       step="900"
                                       pattern="[0-9]{2}:[0-9]{2}"
                                       placeholder="—á—á:–º–º (24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç)">
                                {% if form.start_time.errors %}
                                <div class="text-danger">{{ form.start_time.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π *</label>
                                {{ form.guests_count }}
                                {% if form.guests_count.errors %}
                                <div class="text-danger">{{ form.guests_count.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- –°—Ç–æ–ª–∏–∫ -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–∏–∫ *</label>
                                {{ form.table }}
                                <div id="table-loading" class="text-muted" style="display: none;">
                                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–æ–ª–∏–∫–æ–≤...
                                </div>
                                {% if form.table.errors %}
                                <div class="text-danger">{{ form.table.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å *</label>
                                {{ form.duration }}
                                {% if form.duration.errors %}
                                <div class="text-danger">{{ form.duration.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    {% if form.instance.date and form.instance.start_time %}
                                        –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: {{ form.instance.end_time|time:"H:i" }}
                                    {% else %}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- –°–æ–±—ã—Ç–∏–µ -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">–û—Å–æ–±–æ–µ —Å–æ–±—ã—Ç–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                {{ form.event }}
                                {% if form.event.errors %}
                                <div class="text-danger">{{ form.event.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">–ù–∞–ø—Ä–∏–º–µ—Ä, –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, —é–±–∏–ª–µ–π –∏ —Ç.–¥.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="card mb-4">
                <div class="card-header">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</div>
                <div class="card-body">
                    <p><strong>–ò–º—è:</strong> {{ user.first_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                    <p><strong>–§–∞–º–∏–ª–∏—è:</strong> {{ user.last_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</p>
                    <p><strong>Email:</strong> {{ user.email }}</p>
                    {% if user.phone %}
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ user.phone }}</p>
                    {% endif %}
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'reservation:home' %}" class="btn btn-secondary me-md-2">–û—Ç–º–µ–Ω–∞</a>
                <button type="submit" class="btn btn-primary">
                    {% if form.instance.pk %}üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const hallSelect = document.getElementById('id_hall');
    const dateInput = document.querySelector('input[name="date"]');
    const timeInput = document.querySelector('input[name="start_time"]');
    const guestsInput = document.getElementById('id_guests_count');
    const tableSelect = document.getElementById('id_table');
    const schemaLink = document.getElementById('view-hall-schema');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ö–µ–º—É –∑–∞–ª–∞
    function updateHallSchemaLink() {
        const hallId = hallSelect.value;
        if (hallId && schemaLink) {
            schemaLink.style.display = 'inline';
            schemaLink.href = `/hall/${hallId}/schema/`;
        } else if (schemaLink) {
            schemaLink.style.display = 'none';
        }
    }

    function updateAvailableTables() {
        const hallId = hallSelect.value;
        const date = dateInput.value;
        const time = timeInput.value;
        const guests = guestsInput.value || 1;

        if (!hallId || !date || !time) {
            tableSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è --</option>';
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const loadingDiv = document.getElementById('table-loading');
        if (loadingDiv) loadingDiv.style.display = 'block';
        tableSelect.disabled = true;

        fetch(`/api/tables-by-hall/${hallId}/?date=${date}&time=${time}&guests=${guests}`)
            .then(response => response.json())
            .then(data => {
                tableSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–∏–∫ --</option>';

                if (data.tables && data.tables.length > 0) {
                    data.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.id;
                        option.textContent = `–°—Ç–æ–ª ${table.number} (${table.capacity} —á–µ–ª.)`;
                        tableSelect.appendChild(option);
                    });
                } else {
                    tableSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–æ–ª–∏–∫–æ–≤</option>';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                tableSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–ª–∏–∫–æ–≤</option>';
            })
            .finally(() => {
                if (loadingDiv) loadingDiv.style.display = 'none';
                tableSelect.disabled = false;
            });
    }

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ª–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É —Å—Ä–∞–∑—É
    hallSelect.addEventListener('change', function() {
        updateHallSchemaLink();  // –°—Å—ã–ª–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∑–∞–ª–∞
        updateAvailableTables();
    });

    // –°–ª—É—à–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    dateInput.addEventListener('change', updateAvailableTables);
    timeInput.addEventListener('change', updateAvailableTables);
    guestsInput.addEventListener('change', updateAvailableTables);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateHallSchemaLink();

    // –î–ª—è —Å–ª—É—á–∞—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    {% if form.instance.pk and form.instance.table %}
        const initialHallId = {{ form.instance.table.hall.id }};
        const initialTableId = {{ form.instance.table.id }};

        setTimeout(() => {
            hallSelect.value = initialHallId;
            updateHallSchemaLink();  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            updateAvailableTables();

            // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–ª–∏–∫–æ–≤ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π
            setTimeout(() => {
                if (initialTableId) {
                    tableSelect.value = initialTableId;
                }
            }, 500);
        }, 100);
    {% endif %}
});
</script>
{% endblock %}
